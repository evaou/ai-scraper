# Stock Price Alert Workflow
#
# This workflow monitors stock prices from a Google Sheets spreadsheet and sends
# email alerts when any stock's current price drops to or below its "Low Price"
# threshold as defined in the spreadsheet.
#
# Required GitHub Secrets:
# - GMAIL_USERNAME: Your Gmail address
# - GMAIL_APP_PASSWORD: Your Gmail app password
# - TO_EMAIL: Email address to receive alerts
#
# The workflow automatically:
# 1. Fetches live stock data from Google Sheets
# 2. Compares current prices vs low price thresholds from the spreadsheet
# 3. Sends email alerts highlighting symbols that triggered the alert
# 4. Runs daily at 9:40 PM Taipei time

name: Stock Price Alert Email

on:
  schedule:
    - cron: "40 13 * * *" # Every day at 13:40 UTC (21:40 Taipei / 9:40 PM)
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  stock-alert:
    name: Stock Price Alert
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TZ: UTC
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Check stock prices
        id: stock_check
        run: |
          set -e

          # Make script executable
          chmod +x ./client/get_stock_prices.sh

          echo "ðŸ“ˆ Fetching stock prices from spreadsheet..." >&2

          # Run stock price checker using AI Scraper API with CSV fallback
          STOCK_OUTPUT=$(./client/get_stock_prices.sh --api https://paramita-scraper.duckdns.org/api/v1 --output table --quiet)

          echo "Stock output received:" >&2
          echo "$STOCK_OUTPUT" >&2

          # Check if we have buy opportunities (table contains price data)
          if echo "$STOCK_OUTPUT" | grep -q '\$[0-9]'; then
            echo "ðŸš¨ Buy opportunities detected!" >&2
            HAS_ALERTS="true"
            
            # Extract symbols that have buy opportunities for highlighting
            ALERT_SYMBOLS=$(echo "$STOCK_OUTPUT" | grep '\$[0-9]' | awk '{print $1}' | tr '\n' ',' | sed 's/,$//')
            echo "alert_symbols=$ALERT_SYMBOLS" >> $GITHUB_OUTPUT
          else
            echo "âœ… No buy opportunities found" >&2
            HAS_ALERTS="false"
            echo "alert_symbols=" >> $GITHUB_OUTPUT
          fi

          # Store results for email step
          {
            echo "stock_table<<EOF"
            echo "$STOCK_OUTPUT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "has_alerts=$HAS_ALERTS" >> $GITHUB_OUTPUT

          # Generate timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          TAIPEI_TIME=$(TZ='Asia/Taipei' date +"%Y-%m-%d %H:%M %Z")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "taipei_time=$TAIPEI_TIME" >> $GITHUB_OUTPUT

      - name: Send email alert
        if: steps.stock_check.outputs.has_alerts == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: auto
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "ðŸš¨ Stock Alert: Prices Below Low Thresholds - ${{ steps.stock_check.outputs.taipei_time }}"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.GMAIL_USERNAME }}
          body: |
            ðŸš¨ STOCK PRICE ALERT ðŸš¨

            Generated: ${{ steps.stock_check.outputs.taipei_time }}

            âš¡ SYMBOLS BELOW LOW PRICE: ${{ steps.stock_check.outputs.alert_symbols }}

            Current vs Low Price Comparison:

            ${{ steps.stock_check.outputs.stock_table }}

            ---

            ðŸ“Š Data Source: Google Sheets via AI Scraper API (CSV fallback)
            ðŸŽ¯ Alert Condition: Current price â‰¤ Low price threshold

            This alert was generated automatically when stock prices dropped to or below their low price thresholds as defined in the spreadsheet. Data is fetched via AI Scraper API with automatic CSV fallback for reliability.
          convert_markdown: false

      - name: Workflow summary
        run: |
          echo "## ðŸ“ˆ Stock Price Alert Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**â° Run Time:** ${{ steps.stock_check.outputs.taipei_time }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š Data Source:** Google Sheets via AI Scraper API (CSV fallback)" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Alert Logic:** Current Price â‰¤ Spreadsheet Low Price" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.stock_check.outputs.has_alerts }}" = "true" ]; then
            echo "**ðŸš¨ Status:** Buy opportunities found - Email sent!" >> $GITHUB_STEP_SUMMARY
            echo "**âš¡ Triggered Symbols:** ${{ steps.stock_check.outputs.alert_symbols }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“‹ Stock Results:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.stock_check.outputs.stock_table }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "**âœ… Status:** No buy opportunities - No email sent" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All stocks are currently above their low price thresholds from the spreadsheet." >> $GITHUB_STEP_SUMMARY
          fi
