# Stock Price Alert Workflow
#
# This workflow monitors stock prices from a Google Sheets spreadsheet and sends
# email alerts when any stock's current price drops to or below its "Low Price"
# threshold as defined in the spreadsheet.
#
# Required GitHub Secrets:
# - GMAIL_USERNAME: Your Gmail address
# - GMAIL_APP_PASSWORD: Your Gmail app password
# - TO_EMAIL: Email address to receive alerts
# - JWT_SECRET_KEY: Used for AI Scraper API authentication (enhanced performance)
#
# The workflow automatically:
# 1. Fetches live stock data from Google Sheets
# 2. Compares current prices vs low price thresholds from the spreadsheet
# 3. Sends email alerts highlighting symbols that triggered the alert
# 4. Runs daily at 9:40 PM Taipei time

name: Stock Price Alert Email

on:
  schedule:
    - cron: "40 13 * * *" # Every day at 13:40 UTC (21:40 Taipei / 9:40 PM)
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  stock-alert:
    name: Stock Price Alert
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      AI_SCRAPER_API_URL: http://paramita-scraper.duckdns.org/api/v1
      AI_SCRAPER_API_KEY: ${{ secrets.JWT_SECRET_KEY }}
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
      TZ: UTC
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Check stock prices
        id: stock_check
        run: |
          set -e

          # Make script executable
          chmod +x ./client/get_stock_prices.sh

          echo "üìà Fetching stock prices from spreadsheet..." >&2

          # Validate JWT_SECRET_KEY and test API connectivity
          if [ -z "$AI_SCRAPER_API_KEY" ]; then
            echo "‚ö†Ô∏è Warning: JWT_SECRET_KEY not configured - will use CSV fallback mode" >&2
            echo "   Add JWT_SECRET_KEY to GitHub repository secrets to enable API mode" >&2
            echo "api_mode=no_key" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ JWT_SECRET_KEY configured for API authentication (${AI_SCRAPER_API_KEY:0:8}...)" >&2
            echo "üîç Testing API connectivity and authentication..." >&2
            
            # Test API health and authentication
            if curl -f -s -m 10 http://paramita-scraper.duckdns.org/health > /dev/null; then
              echo "‚úÖ API server is accessible" >&2
              
              # Test authentication with a simple API call
              AUTH_TEST=$(curl -s -w "%{http_code}" -X POST "$AI_SCRAPER_API_URL/scrape" \
                -H "Content-Type: application/json" \
                -H "X-API-Key: $AI_SCRAPER_API_KEY" \
                -d '{"url": "https://httpbin.org/html"}' 2>/dev/null || echo "000")
              HTTP_CODE="${AUTH_TEST: -3}"
              
              if [ "$HTTP_CODE" = "202" ]; then
                echo "‚úÖ API authentication successful - enhanced mode active" >&2
                echo "api_mode=enhanced" >> $GITHUB_OUTPUT
              elif [ "$HTTP_CODE" = "401" ]; then
                echo "‚ö†Ô∏è API authentication failed - JWT key not registered, using CSV fallback" >&2
                echo "api_mode=fallback_auth" >> $GITHUB_OUTPUT
              else
                echo "‚ö†Ô∏è API server issue (HTTP $HTTP_CODE) - using CSV fallback" >&2
                echo "api_mode=fallback_server" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ö†Ô∏è API health check failed, will use CSV fallback" >&2
              echo "api_mode=fallback_health" >> $GITHUB_OUTPUT
            fi
          fi

          # Run stock price checker based on API mode availability
          echo "üìä Running stock price fetcher..." >&2
          set +e  # Allow script to continue if stock fetch fails

          # Use API mode if authentication was successful
          API_MODE=$(grep "api_mode=" $GITHUB_OUTPUT | cut -d'=' -f2 || echo "unknown")
          if [ "$API_MODE" = "enhanced" ]; then
            echo "üöÄ Using enhanced API mode with authentication..." >&2
            STOCK_OUTPUT=$(./client/get_stock_prices.sh --api "$AI_SCRAPER_API_URL" --output table 2>&1)
            FETCH_EXIT_CODE=$?
          else
            echo "üìÅ API mode not available ($API_MODE), using CSV fallback..." >&2
            STOCK_OUTPUT=$(./client/get_stock_prices.sh --output table 2>&1)
            FETCH_EXIT_CODE=$?
          fi

          set -e

          echo "Stock fetcher exit code: $FETCH_EXIT_CODE" >&2
          echo "Stock output received:" >&2
          echo "$STOCK_OUTPUT" >&2

          # If primary method failed, try fallback
          if [ $FETCH_EXIT_CODE -ne 0 ] && [ "$API_MODE" = "enhanced" ]; then
            echo "‚ö†Ô∏è API mode failed, trying CSV fallback..." >&2
            STOCK_OUTPUT=$(./client/get_stock_prices.sh --output table 2>&1)
            echo "CSV fallback output:" >&2
            echo "$STOCK_OUTPUT" >&2
          fi

          # Check if we have valid stock data
          if echo "$STOCK_OUTPUT" | grep -E -q "(Symbol|Stock|\$[0-9]|Price)"; then
            echo "üìä Valid stock data received" >&2
            
            # Check if we have buy opportunities (table contains price data)
            if echo "$STOCK_OUTPUT" | grep -q '\$[0-9]'; then
              echo "üö® Buy opportunities detected!" >&2
              HAS_ALERTS="true"
              
              # Extract symbols that have buy opportunities for highlighting
              ALERT_SYMBOLS=$(echo "$STOCK_OUTPUT" | grep '\$[0-9]' | awk '{print $1}' | tr '\n' ',' | sed 's/,$//')
              echo "alert_symbols=$ALERT_SYMBOLS" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ No buy opportunities found" >&2
              HAS_ALERTS="false"
              echo "alert_symbols=" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è No valid stock data received - may be temporary API issue" >&2
            HAS_ALERTS="false"
            echo "alert_symbols=" >> $GITHUB_OUTPUT
            # Add warning to stock output
            STOCK_OUTPUT="‚ö†Ô∏è Stock data temporarily unavailable\n\nThis may be due to:\n- API connectivity issues\n- Google Sheets access problems\n- Temporary service downtime\n\nThe system will retry on the next scheduled run.\n\nOriginal output:\n$STOCK_OUTPUT"
          fi

          # Store results for email step
          {
            echo "stock_table<<EOF"
            echo "$STOCK_OUTPUT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "has_alerts=$HAS_ALERTS" >> $GITHUB_OUTPUT

          # Generate timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          TAIPEI_TIME=$(TZ='Asia/Taipei' date +"%Y-%m-%d %H:%M %Z")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "taipei_time=$TAIPEI_TIME" >> $GITHUB_OUTPUT

      - name: Send email alert
        if: steps.stock_check.outputs.has_alerts == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: auto
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "üö® Stock Alert: Prices Below Low Thresholds - ${{ steps.stock_check.outputs.taipei_time }}"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.GMAIL_USERNAME }}
          body: |
            üö® STOCK PRICE ALERT üö®

            Generated: ${{ steps.stock_check.outputs.taipei_time }}

            ‚ö° SYMBOLS BELOW LOW PRICE: ${{ steps.stock_check.outputs.alert_symbols }}

            Current vs Low Price Comparison:

            ${{ steps.stock_check.outputs.stock_table }}

      - name: Workflow summary
        if: always()
        run: |
          echo "üìä Stock Price Alert Workflow Summary"
          echo "======================================"
          echo "Timestamp: ${{ steps.stock_check.outputs.taipei_time }}"
          echo "Has Alerts: ${{ steps.stock_check.outputs.has_alerts }}"
          echo "Alert Symbols: ${{ steps.stock_check.outputs.alert_symbols }}"

          if [[ "${{ steps.stock_check.outputs.has_alerts }}" == "true" ]]; then
            echo "‚úÖ Email alert sent for symbols: ${{ steps.stock_check.outputs.alert_symbols }}"
          else
            echo "‚úÖ No alerts triggered - all stocks above low price thresholds"
          fi

          echo ""
          echo "üîç Next scheduled run: Every day at 21:40 Taipei time (13:40 UTC)"

      - name: Workflow summary
        run: |
          echo "## üìà Stock Price Alert Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**‚è∞ Run Time:** ${{ steps.stock_check.outputs.taipei_time }}" >> $GITHUB_STEP_SUMMARY

          # Add API mode information
          API_MODE="${{ steps.stock_check.outputs.api_mode }}"
          case "$API_MODE" in
            "enhanced")
              echo "**ÔøΩ Mode:** Enhanced API mode with JWT authentication" >> $GITHUB_STEP_SUMMARY
              ;;
            "fallback_auth")
              echo "**‚öôÔ∏è Mode:** CSV fallback (JWT key not registered in database)" >> $GITHUB_STEP_SUMMARY
              ;;
            "fallback_server")
              echo "**‚öôÔ∏è Mode:** CSV fallback (API server issue)" >> $GITHUB_STEP_SUMMARY
              ;;
            "fallback_health")
              echo "**‚öôÔ∏è Mode:** CSV fallback (API health check failed)" >> $GITHUB_STEP_SUMMARY
              ;;
            "no_key")
              echo "**‚öôÔ∏è Mode:** CSV fallback (JWT_SECRET_KEY not configured)" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "**üìä Mode:** CSV mode" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          echo "**üìä Data Source:** Google Sheets (API mode when available, CSV fallback)" >> $GITHUB_STEP_SUMMARY
          echo "**üéØ Alert Logic:** Current Price ‚â§ Spreadsheet Low Price" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.stock_check.outputs.has_alerts }}" = "true" ]; then
            echo "**üö® Status:** Buy opportunities found - Email sent!" >> $GITHUB_STEP_SUMMARY
            echo "**‚ö° Triggered Symbols:** ${{ steps.stock_check.outputs.alert_symbols }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**üìã Stock Results:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.stock_check.outputs.stock_table }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "**‚úÖ Status:** No buy opportunities - No email sent" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All stocks are currently above their low price thresholds from the spreadsheet." >> $GITHUB_STEP_SUMMARY
          fi
