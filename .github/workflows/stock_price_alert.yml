name: Stock Price Alert Email

on:
  schedule:
    - cron: "40 13 * * *" # Every day at 13:40 UTC (21:40 Taipei / 9:40 PM)
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  stock-alert:
    name: Stock Price Alert
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TZ: UTC
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Check stock prices
        id: stock_check
        run: |
          set -e

          # Make script executable
          chmod +x ./client/get_stock_prices.sh

          echo "ðŸ“ˆ Fetching stock prices..." >&2

          # Run stock price checker with GitHub secrets
          STOCK_OUTPUT=$(./client/get_stock_prices.sh \
            --symbols "${{ secrets.STOCK_SYMBOLS }}" \
            --thresholds "${{ secrets.STOCK_THRESHOLDS }}" \
            --output table)

          echo "Stock output received:" >&2
          echo "$STOCK_OUTPUT" >&2

          # Check if we have buy opportunities (table contains price data)
          if echo "$STOCK_OUTPUT" | grep -q '\$[0-9]'; then
            echo "âœ… Buy opportunities detected!" >&2
            HAS_ALERTS="true"
          else
            echo "â„¹ï¸ No buy opportunities found" >&2
            HAS_ALERTS="false"
          fi

          # Store results for email step
          {
            echo "stock_table<<EOF"
            echo "$STOCK_OUTPUT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "has_alerts=$HAS_ALERTS" >> $GITHUB_OUTPUT

          # Generate timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          TAIPEI_TIME=$(TZ='Asia/Taipei' date +"%Y-%m-%d %H:%M %Z")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "taipei_time=$TAIPEI_TIME" >> $GITHUB_OUTPUT

      - name: Send email alert
        if: steps.stock_check.outputs.has_alerts == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: auto
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "ðŸŽ¯ Stock Buy Opportunities Alert - ${{ steps.stock_check.outputs.taipei_time }}"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.GMAIL_USERNAME }}
          body: |
            Stock Buy Opportunities Alert

            Generated: ${{ steps.stock_check.outputs.taipei_time }}

            Buy Opportunities Found:

            ${{ steps.stock_check.outputs.stock_table }}

            ---

            Symbols monitored: ${{ secrets.STOCK_SYMBOLS }}
            Price thresholds: ${{ secrets.STOCK_THRESHOLDS }}

            This alert was generated automatically when stocks fell below their target prices.
          convert_markdown: false

      - name: Workflow summary
        run: |
          echo "## ðŸ“ˆ Stock Price Alert Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**â° Run Time:** ${{ steps.stock_check.outputs.taipei_time }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š Symbols:** ${{ secrets.STOCK_SYMBOLS }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Thresholds:** ${{ secrets.STOCK_THRESHOLDS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.stock_check.outputs.has_alerts }}" = "true" ]; then
            echo "**ðŸš¨ Status:** Buy opportunities found - Email sent!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“‹ Stock Results:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.stock_check.outputs.stock_table }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "**âœ… Status:** No buy opportunities - No email sent" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All monitored stocks are currently above their target prices." >> $GITHUB_STEP_SUMMARY
          fi
