name: Email USD Spot Selling Rate

on:
  schedule:
    - cron: "0 5 * * *" # Every day at 05:00 UTC (13:00 Taipei)
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  send-usd-spot-email:
    name: Collect & Email USD Spot Selling Rate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      AI_SCRAPER_API_URL: https://paramita-scraper.duckdns.org/api/v1
      TZ: UTC
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Ensure script is executable
        run: chmod +x client/get_usd_rate.sh

      - name: Collect USD spot selling rate
        id: collect
        run: |
          set -e
          echo "Fetching USD rate using get_usd_rate.sh..." >&2
          RATE=""
          for i in 1 2 3; do
            echo "Attempt $i: Fetching USD rate..." >&2
            
            # For first attempt, show verbose output for debugging
            if [ "$i" -eq 1 ]; then
              echo "Debug output (verbose):" >&2
              ./client/get_usd_rate.sh --api "$AI_SCRAPER_API_URL" || echo "Verbose run completed with errors" >&2
            fi
            
            # Actual rate collection with quiet flag
            RATE=$(./client/get_usd_rate.sh --api "$AI_SCRAPER_API_URL" --quiet 2>/dev/null || true)
            if [ -n "$RATE" ]; then
              echo "âœ… Got rate on attempt $i: $RATE" >&2
              break
            fi
            echo "âŒ Attempt $i failed; retrying in 15s..." >&2
            [ "$i" -lt 3 ] && sleep 15
          done

          if [ -z "$RATE" ]; then
            echo "Rate collection failed after retries" >&2
            echo "rate=" >> $GITHUB_OUTPUT
            echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
            exit 0  # Non-fatal; email step will reflect failure
          fi

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Convert to Taipei time for email display
          TS_TAIPEI=$(TZ='Asia/Taipei' date -d "$TS" +"%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || TZ='Asia/Taipei' date -j -f "%Y-%m-%dT%H:%M:%SZ" "$TS" +"%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "$TS")
          echo "Collected rate: $RATE at $TS_TAIPEI" >&2
          echo "rate=$RATE" >> $GITHUB_OUTPUT
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "timestamp_taipei=$TS_TAIPEI" >> $GITHUB_OUTPUT

      - name: Check rate threshold and build email content
        id: email
        shell: bash
        run: |
          RATE="${{ steps.collect.outputs.rate }}"
          TS="${{ steps.collect.outputs.timestamp }}"
          TS_TAIPEI="${{ steps.collect.outputs.timestamp_taipei }}"
          THRESHOLD="${{ secrets.USD_RATE_THRESHOLD }}"

          # Set default threshold if not configured
          if [ -z "$THRESHOLD" ]; then
            THRESHOLD="32.0"
            echo "âš ï¸ No USD_RATE_THRESHOLD secret set, using default: $THRESHOLD" >&2
          fi

          echo "ðŸ“Š Current rate: $RATE, Threshold: $THRESHOLD" >&2

          # Determine if email should be sent
          SEND_EMAIL="false"

          if [ -z "$RATE" ]; then
            # Don't send email for collection failures
            SEND_EMAIL="false"
            echo "âŒ Rate collection failed - no email will be sent" >&2
          else
            # Compare rate with threshold (using bc for decimal comparison)
            if command -v bc >/dev/null 2>&1; then
              if [ "$(echo "$RATE <= $THRESHOLD" | bc -l)" -eq 1 ]; then
                SEND_EMAIL="true"
                SUBJECT="ðŸŽ¯ USD Alert: $RATE TWD (â‰¤ $THRESHOLD)"
                BODY="USD rate dropped to $RATE TWD (threshold: $THRESHOLD TWD)\nTimestamp: $TS_TAIPEI"
                echo "ðŸŽ¯ Rate $RATE is at/below threshold $THRESHOLD - email will be sent" >&2
              else
                SEND_EMAIL="false"
                echo "ðŸ“ˆ Rate $RATE is above threshold $THRESHOLD - no email needed" >&2
              fi
            else
              # Fallback comparison for systems without bc
              RATE_INT=$(echo "$RATE * 1000" | cut -d. -f1)
              THRESHOLD_INT=$(echo "$THRESHOLD * 1000" | cut -d. -f1)
              if [ "$RATE_INT" -le "$THRESHOLD_INT" ]; then
                SEND_EMAIL="true"
                SUBJECT="ðŸŽ¯ USD Alert: $RATE TWD (â‰¤ $THRESHOLD)"
                BODY="USD rate dropped to $RATE TWD (threshold: $THRESHOLD TWD)\nTimestamp: $TS_TAIPEI"
                echo "ðŸŽ¯ Rate $RATE is at/below threshold $THRESHOLD - email will be sent" >&2
              else
                SEND_EMAIL="false"
                echo "ðŸ“ˆ Rate $RATE is above threshold $THRESHOLD - no email needed" >&2
              fi
            fi
          fi

          # Escape for GitHub output
          SUBJECT_ESCAPED=${SUBJECT//'%'/'%25'}
          BODY_ESCAPED=${BODY//'%'/'%25'}
          BODY_ESCAPED=${BODY_ESCAPED//$'\n'/'%0A'}
          BODY_ESCAPED=${BODY_ESCAPED//$'\r'/'%0D'}
          echo "subject=$SUBJECT_ESCAPED" >> $GITHUB_OUTPUT
          echo "body=$BODY_ESCAPED" >> $GITHUB_OUTPUT
          echo "send_email=$SEND_EMAIL" >> $GITHUB_OUTPUT

      - name: Send email via Gmail SMTP
        if: steps.email.outputs.send_email == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: auto
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: ${{ steps.email.outputs.subject }}
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.GMAIL_USERNAME }}
          body: ${{ steps.email.outputs.body }}
          convert_markdown: false
          ignore_cert: false

      - name: Summary
        run: |
          echo "## USD Rate Email Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RATE="${{ steps.collect.outputs.rate }}"
          THRESHOLD="${{ secrets.USD_RATE_THRESHOLD }}"
          SEND_EMAIL="${{ steps.email.outputs.send_email }}"

          if [ -z "$THRESHOLD" ]; then
            THRESHOLD="32.0 (default)"
          fi

          if [ -n "$RATE" ]; then
            echo "ðŸ“Š **Current Rate**: $RATE TWD" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **Threshold**: $THRESHOLD TWD" >> $GITHUB_STEP_SUMMARY
            if [ "$SEND_EMAIL" = "true" ]; then
              echo "ðŸ“§ **Action**: Email sent (rate â‰¤ threshold)" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸš« **Action**: No email (rate > threshold)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Failed**: Could not collect USD rate" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš« **Action**: No email sent for failures" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ Timestamp: ${{ steps.collect.outputs.timestamp_taipei }}" >> $GITHUB_STEP_SUMMARY
