# Email USD Spot Selling Rate Workflow
#
# This workflow fetches USD selling rates and sends email alerts when rates drop below threshold.
# Uses AI Scraper API for enhanced performance (via JWT_SECRET_KEY authentication) with manual fallback.
#
# Required GitHub Secrets:
# - GMAIL_USERNAME: Your Gmail address
# - GMAIL_APP_PASSWORD: Your Gmail app password
# - TO_EMAIL: Email address to receive alerts
# - USD_RATE_THRESHOLD: Rate threshold (optional, defaults to 32.0)
# - JWT_SECRET_KEY: Used for AI Scraper API authentication (enhanced performance)

name: Email USD Spot Selling Rate

on:
  schedule:
    - cron: "0 5 * * *" # Every day at 05:00 UTC (13:00 Taipei)
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  send-usd-spot-email:
    name: Collect & Email USD Spot Selling Rate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      AI_SCRAPER_API_URL: http://paramita-scraper.duckdns.org/api/v1
      AI_SCRAPER_API_KEY: ${{ secrets.JWT_SECRET_KEY }}
      TZ: UTC
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Ensure script is executable
        run: chmod +x client/get_usd_rate.sh

      - name: Collect USD spot selling rate
        id: collect
        run: |
          set -e
          echo "Fetching USD rate using get_usd_rate.sh..." >&2

          # Validate JWT_SECRET_KEY is configured
          if [ -z "$AI_SCRAPER_API_KEY" ]; then
            echo "âš ï¸ Warning: JWT_SECRET_KEY not configured - API mode will not work" >&2
            echo "   Add JWT_SECRET_KEY to GitHub repository secrets to enable enhanced mode" >&2
          else
            echo "âœ… JWT_SECRET_KEY configured for API authentication" >&2
          fi
          RATE=""
          for i in 1 2 3; do
            echo "Attempt $i: Fetching USD rate..." >&2
            
            # For first attempt, show verbose output for debugging
            if [ "$i" -eq 1 ]; then
              echo "Debug: Testing API authentication..." >&2
              echo "Debug: JWT key configured: ${AI_SCRAPER_API_KEY:+YES (${AI_SCRAPER_API_KEY:0:8}...)}" >&2
              API_TEST=$(curl -s -w "%{http_code}" -X POST "$AI_SCRAPER_API_URL/scrape" \
                -H "Content-Type: application/json" \
                -H "X-API-Key: ${AI_SCRAPER_API_KEY:-}" \
                -d '{"url": "https://httpbin.org/html"}' 2>/dev/null || echo "000")
              HTTP_CODE="${API_TEST: -3}"
              if [ "$HTTP_CODE" = "202" ]; then
                echo "âœ… API authentication successful - enhanced mode active" >&2
                echo "api_mode=enhanced" >> $GITHUB_OUTPUT
              elif [ "$HTTP_CODE" = "401" ]; then
                echo "âš ï¸ API authentication failed (JWT key not registered) - using fallback mode" >&2
                echo "api_mode=fallback_auth" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸ API server issue (HTTP $HTTP_CODE) - using fallback mode" >&2
                echo "api_mode=fallback_server" >> $GITHUB_OUTPUT
              fi
              
              echo "Debug output (verbose):" >&2
              ./client/get_usd_rate.sh --api "$AI_SCRAPER_API_URL" || echo "Verbose run completed" >&2
            fi
            
            # Actual rate collection with quiet flag - try API first, auto-fallback to manual
            RATE=$(./client/get_usd_rate.sh --api "$AI_SCRAPER_API_URL" --quiet 2>/dev/null || true)
            if [ -n "$RATE" ]; then
              echo "âœ… Got rate on attempt $i: $RATE" >&2
              break
            fi
            echo "âŒ Attempt $i failed; retrying in 15s..." >&2
            [ "$i" -lt 3 ] && sleep 15
          done

          if [ -z "$RATE" ]; then
            echo "Rate collection failed after retries" >&2
            echo "rate=" >> $GITHUB_OUTPUT
            echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
            exit 0  # Non-fatal; email step will reflect failure
          fi

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Convert to Taipei time for email display
          TS_TAIPEI=$(TZ='Asia/Taipei' date -d "$TS" +"%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || TZ='Asia/Taipei' date -j -f "%Y-%m-%dT%H:%M:%SZ" "$TS" +"%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "$TS")
          echo "Collected rate: $RATE at $TS_TAIPEI" >&2
          echo "rate=$RATE" >> $GITHUB_OUTPUT
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "timestamp_taipei=$TS_TAIPEI" >> $GITHUB_OUTPUT

      - name: Check rate threshold and build email content
        id: email
        shell: bash
        run: |
          RATE="${{ steps.collect.outputs.rate }}"
          TS="${{ steps.collect.outputs.timestamp }}"
          TS_TAIPEI="${{ steps.collect.outputs.timestamp_taipei }}"
          THRESHOLD="${{ secrets.USD_RATE_THRESHOLD }}"

          # Set default threshold if not configured
          if [ -z "$THRESHOLD" ]; then
            THRESHOLD="32.0"
            echo "âš ï¸ No USD_RATE_THRESHOLD secret set, using default: $THRESHOLD" >&2
          fi

          echo "ðŸ“Š Current rate: $RATE, Threshold: $THRESHOLD" >&2

          # Determine if email should be sent
          SEND_EMAIL="false"

          if [ -z "$RATE" ]; then
            # Don't send email for collection failures
            SEND_EMAIL="false"
            echo "âŒ Rate collection failed - no email will be sent" >&2
          else
            # Compare rate with threshold (using bc for decimal comparison)
            if command -v bc >/dev/null 2>&1; then
              if [ "$(echo "$RATE <= $THRESHOLD" | bc -l)" -eq 1 ]; then
                SEND_EMAIL="true"
                SUBJECT="ðŸŽ¯ USD Alert: $RATE TWD (â‰¤ $THRESHOLD)"
                BODY="USD rate dropped to $RATE TWD (threshold: $THRESHOLD TWD)\nTimestamp: $TS_TAIPEI"
                echo "ðŸŽ¯ Rate $RATE is at/below threshold $THRESHOLD - email will be sent" >&2
              else
                SEND_EMAIL="false"
                echo "ðŸ“ˆ Rate $RATE is above threshold $THRESHOLD - no email needed" >&2
              fi
            else
              # Fallback comparison for systems without bc
              RATE_INT=$(echo "$RATE * 1000" | cut -d. -f1)
              THRESHOLD_INT=$(echo "$THRESHOLD * 1000" | cut -d. -f1)
              if [ "$RATE_INT" -le "$THRESHOLD_INT" ]; then
                SEND_EMAIL="true"
                SUBJECT="ðŸŽ¯ USD Alert: $RATE TWD (â‰¤ $THRESHOLD)"
                BODY="USD rate dropped to $RATE TWD (threshold: $THRESHOLD TWD)\nTimestamp: $TS_TAIPEI"
                echo "ðŸŽ¯ Rate $RATE is at/below threshold $THRESHOLD - email will be sent" >&2
              else
                SEND_EMAIL="false"
                echo "ðŸ“ˆ Rate $RATE is above threshold $THRESHOLD - no email needed" >&2
              fi
            fi
          fi

          # Escape for GitHub output
          SUBJECT_ESCAPED=${SUBJECT//'%'/'%25'}
          BODY_ESCAPED=${BODY//'%'/'%25'}
          BODY_ESCAPED=${BODY_ESCAPED//$'\n'/'%0A'}
          BODY_ESCAPED=${BODY_ESCAPED//$'\r'/'%0D'}
          echo "subject=$SUBJECT_ESCAPED" >> $GITHUB_OUTPUT
          echo "body=$BODY_ESCAPED" >> $GITHUB_OUTPUT
          echo "send_email=$SEND_EMAIL" >> $GITHUB_OUTPUT

      - name: Send email via Gmail SMTP
        if: steps.email.outputs.send_email == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: auto
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: ${{ steps.email.outputs.subject }}
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.GMAIL_USERNAME }}
          body: ${{ steps.email.outputs.body }}
          convert_markdown: false
          ignore_cert: false

      - name: Summary
        run: |
          echo "## USD Rate Email Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RATE="${{ steps.collect.outputs.rate }}"
          THRESHOLD="${{ secrets.USD_RATE_THRESHOLD }}"
          SEND_EMAIL="${{ steps.email.outputs.send_email }}"

          if [ -z "$THRESHOLD" ]; then
            THRESHOLD="32.0 (default)"
          fi

          if [ -n "$RATE" ]; then
            echo "ðŸ“Š **Current Rate**: $RATE TWD" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **Threshold**: $THRESHOLD TWD" >> $GITHUB_STEP_SUMMARY
            
            # Use the actual API mode from the collection step
            API_MODE="${{ steps.collect.outputs.api_mode }}"
            case "$API_MODE" in
              "enhanced")
                echo "ðŸš€ **Mode**: Enhanced API mode (faster processing)" >> $GITHUB_STEP_SUMMARY
                ;;
              "fallback_auth")
                echo "âš™ï¸ **Mode**: Fallback mode (JWT key not registered - run deployment to enable API)" >> $GITHUB_STEP_SUMMARY
                ;;
              "fallback_server")
                echo "âš™ï¸ **Mode**: Fallback mode (API server issue)" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "âš™ï¸ **Mode**: Fallback mode (API unavailable)" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
            
            if [ "$SEND_EMAIL" = "true" ]; then
              echo "ðŸ“§ **Action**: Email sent (rate â‰¤ threshold)" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸš« **Action**: No email (rate > threshold)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Failed**: Could not collect USD rate" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš« **Action**: No email sent for failures" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ Timestamp: ${{ steps.collect.outputs.timestamp_taipei }}" >> $GITHUB_STEP_SUMMARY
