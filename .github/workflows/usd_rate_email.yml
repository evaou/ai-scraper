# Email USD Spot Selling Rate Workflow
#
# This workflow fetches USD selling rates and sends email alerts when rates drop below threshold.
# Uses enhanced API mode with smart anti-detection first, then falls back to manual scraping if needed.
#
# COLLECTION STRATEGY:
# 1. Enhanced API Mode: Smart anti-detection with stealth features, human simulation, advanced headers
# 2. Manual Fallback: Direct HTTP requests with browser headers if API mode fails
#
# Required GitHub Secrets:
# - GMAIL_USERNAME: Your Gmail address
# - GMAIL_APP_PASSWORD: Your Gmail app password
# - TO_EMAIL: Email address to receive alerts
# - USD_RATE_THRESHOLD: Rate threshold (optional, defaults to 32.0)
# - JWT_SECRET_KEY: API authentication for enhanced mode (optional, falls back to manual if not set)

name: Email USD Spot Selling Rate

on:
  schedule:
    - cron: "0 5 * * *" # Every day at 05:00 UTC (13:00 Taipei)
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  send-usd-spot-email:
    name: Collect & Email USD Spot Selling Rate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      AI_SCRAPER_API_URL: http://paramita-scraper.duckdns.org/api/v1
      AI_SCRAPER_API_KEY: ${{ secrets.JWT_SECRET_KEY }}
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
      TZ: UTC
      # Enhanced anti-detection settings
      USD_SCRAPER_ENHANCED_MODE: true
      USD_SCRAPER_STEALTH_MODE: true
      USD_SCRAPER_SIMULATE_HUMAN: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Ensure script is executable
        run: chmod +x client/get_usd_rate.sh

      - name: Collect USD spot selling rate
        id: collect
        run: |
          set -e
          echo "Fetching USD rate using get_usd_rate.sh..." >&2

          # Check API key configuration
          if [ -z "$AI_SCRAPER_API_KEY" ]; then
            echo "âš ï¸ JWT_SECRET_KEY not configured - using manual fallback only" >&2
            echo "api_mode=no_key" >> $GITHUB_OUTPUT
          else
            echo "ðŸ›¡ï¸ Enhanced API mode with smart anti-detection enabled" >&2
          fi
          # Attempt to collect rate using enhanced API mode first, then manual fallback
          RATE=""

          # Try enhanced API mode if API key is available
          if [ -n "$AI_SCRAPER_API_KEY" ]; then
            echo "ðŸš€ Trying enhanced API mode with smart anti-detection..." >&2
            RATE=$(./client/get_usd_rate.sh --api "$AI_SCRAPER_API_URL" --enhanced --quiet 2>/dev/null || true)
            
            # Validate that output is numeric
            if echo "$RATE" | grep -qE '^[0-9]+\.[0-9]+$'; then
              echo "âœ… Enhanced API mode successful: $RATE" >&2
              echo "api_mode=enhanced_smart" >> $GITHUB_OUTPUT
            else
              RATE=""
              echo "âš ï¸ Enhanced API mode failed, trying manual fallback..." >&2
            fi
          fi

          # Fallback to manual mode if API failed or no API key
          if [ -z "$RATE" ]; then
            echo "ï¿½ Using manual fallback mode..." >&2
            RATE=$(./client/get_usd_rate.sh --quiet 2>/dev/null || true)
            
            # Validate that output is numeric
            if echo "$RATE" | grep -qE '^[0-9]+\.[0-9]+$'; then
              echo "âœ… Manual fallback successful: $RATE" >&2
              if [ -z "$AI_SCRAPER_API_KEY" ]; then
                echo "api_mode=manual_only" >> $GITHUB_OUTPUT
              else
                echo "api_mode=manual_fallback" >> $GITHUB_OUTPUT
              fi
            else
              RATE=""
              echo "âŒ Manual fallback also failed" >&2
              echo "api_mode=failed" >> $GITHUB_OUTPUT
            fi
          fi

          # Handle failure case
          if [ -z "$RATE" ]; then
            echo "âŒ Rate collection failed completely" >&2
            echo "rate=" >> $GITHUB_OUTPUT
            echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
            echo "timestamp_taipei=" >> $GITHUB_OUTPUT
            exit 0  # Non-fatal; email step will reflect failure
          fi

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Convert to Taipei time for email display
          TS_TAIPEI=$(TZ='Asia/Taipei' date -d "$TS" +"%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || TZ='Asia/Taipei' date -j -f "%Y-%m-%dT%H:%M:%SZ" "$TS" +"%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "$TS")
          echo "Collected rate: $RATE at $TS_TAIPEI" >&2
          echo "rate=$RATE" >> $GITHUB_OUTPUT
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "timestamp_taipei=$TS_TAIPEI" >> $GITHUB_OUTPUT

      - name: Check rate threshold and build email content
        id: email
        shell: bash
        run: |
          RATE="${{ steps.collect.outputs.rate }}"
          TS="${{ steps.collect.outputs.timestamp }}"
          TS_TAIPEI="${{ steps.collect.outputs.timestamp_taipei }}"
          THRESHOLD="${{ secrets.USD_RATE_THRESHOLD }}"

          # Set default threshold if not configured
          if [ -z "$THRESHOLD" ]; then
            THRESHOLD="32.0"
            echo "âš ï¸ No USD_RATE_THRESHOLD secret set, using default: $THRESHOLD" >&2
          fi

          # Validate that RATE is numeric before proceeding
          if [ -n "$RATE" ] && ! echo "$RATE" | grep -qE '^[0-9]+\.[0-9]+$'; then
            echo "âš ï¸ Warning: Rate value '$RATE' is not numeric, treating as collection failure" >&2
            RATE=""
          fi

          echo "ðŸ“Š Current rate: ${RATE:-'FAILED'}, Threshold: $THRESHOLD" >&2

          # Determine if email should be sent
          SEND_EMAIL="false"

          if [ -z "$RATE" ]; then
            # Don't send email for collection failures
            SEND_EMAIL="false"
            echo "âŒ Rate collection failed - no email will be sent" >&2
          else
            # Compare rate with threshold (using bc for decimal comparison)
            if command -v bc >/dev/null 2>&1; then
              if [ "$(echo "$RATE <= $THRESHOLD" | bc -l)" -eq 1 ]; then
                SEND_EMAIL="true"
                SUBJECT="ðŸŽ¯ USD Alert: $RATE TWD (â‰¤ $THRESHOLD)"
                BODY="USD rate dropped to $RATE TWD (threshold: $THRESHOLD TWD)\nTimestamp: $TS_TAIPEI"
                echo "ðŸŽ¯ Rate $RATE is at/below threshold $THRESHOLD - email will be sent" >&2
              else
                SEND_EMAIL="false"
                echo "ðŸ“ˆ Rate $RATE is above threshold $THRESHOLD - no email needed" >&2
              fi
            else
              # Fallback comparison for systems without bc
              # Convert to integers by multiplying by 1000 and removing decimal
              RATE_INT=$(echo "$RATE" | awk '{printf "%.0f", $1 * 1000}')
              THRESHOLD_INT=$(echo "$THRESHOLD" | awk '{printf "%.0f", $1 * 1000}')
              if [ "$RATE_INT" -le "$THRESHOLD_INT" ]; then
                SEND_EMAIL="true"
                SUBJECT="ðŸŽ¯ USD Alert: $RATE TWD (â‰¤ $THRESHOLD)"
                BODY="USD rate dropped to $RATE TWD (threshold: $THRESHOLD TWD)\nTimestamp: $TS_TAIPEI"
                echo "ðŸŽ¯ Rate $RATE is at/below threshold $THRESHOLD - email will be sent" >&2
              else
                SEND_EMAIL="false"
                echo "ðŸ“ˆ Rate $RATE is above threshold $THRESHOLD - no email needed" >&2
              fi
            fi
          fi

          # Escape for GitHub output (only if variables are set)
          if [ -n "${SUBJECT:-}" ]; then
            SUBJECT_ESCAPED=${SUBJECT//'%'/'%25'}
            echo "subject=$SUBJECT_ESCAPED" >> $GITHUB_OUTPUT
          else
            echo "subject=" >> $GITHUB_OUTPUT
          fi

          if [ -n "${BODY:-}" ]; then
            BODY_ESCAPED=${BODY//'%'/'%25'}
            BODY_ESCAPED=${BODY_ESCAPED//$'\n'/'%0A'}
            BODY_ESCAPED=${BODY_ESCAPED//$'\r'/'%0D'}
            echo "body=$BODY_ESCAPED" >> $GITHUB_OUTPUT
          else
            echo "body=" >> $GITHUB_OUTPUT
          fi

          echo "send_email=$SEND_EMAIL" >> $GITHUB_OUTPUT

      - name: Send email via Gmail SMTP
        if: steps.email.outputs.send_email == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: auto
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: ${{ steps.email.outputs.subject }}
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.GMAIL_USERNAME }}
          body: ${{ steps.email.outputs.body }}
          convert_markdown: false
          ignore_cert: false

      - name: Summary
        run: |
          echo "## USD Rate Email Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RATE="${{ steps.collect.outputs.rate }}"
          THRESHOLD="${{ secrets.USD_RATE_THRESHOLD }}"
          SEND_EMAIL="${{ steps.email.outputs.send_email }}"

          if [ -z "$THRESHOLD" ]; then
            THRESHOLD="32.0 (default)"
          fi

          if [ -n "$RATE" ]; then
            echo "ðŸ“Š **Current Rate**: $RATE TWD" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **Threshold**: $THRESHOLD TWD" >> $GITHUB_STEP_SUMMARY
            
            # Use the actual API mode from the collection step
            API_MODE="${{ steps.collect.outputs.api_mode }}"
            case "$API_MODE" in
              "enhanced_smart")
                echo "ðŸ›¡ï¸ **Mode**: Smart Anti-Detection API (stealth features, human simulation)" >> $GITHUB_STEP_SUMMARY
                ;;
              "manual_fallback")
                echo "ï¿½ **Mode**: Manual Fallback (API enhanced mode failed)" >> $GITHUB_STEP_SUMMARY
                ;;
              "manual_only")
                echo "âš™ï¸ **Mode**: Manual Only (no API key configured)" >> $GITHUB_STEP_SUMMARY
                ;;
              "no_key")
                echo "âš ï¸ **Mode**: No API Key (manual fallback only)" >> $GITHUB_STEP_SUMMARY
                ;;
              "failed")
                echo "âŒ **Mode**: All methods failed" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "âš™ï¸ **Mode**: Unknown ($API_MODE)" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
            
            if [ "$SEND_EMAIL" = "true" ]; then
              echo "ðŸ“§ **Action**: Email sent (rate â‰¤ threshold)" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸš« **Action**: No email (rate > threshold)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Failed**: Could not collect USD rate" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš« **Action**: No email sent for failures" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ Timestamp: ${{ steps.collect.outputs.timestamp_taipei }}" >> $GITHUB_STEP_SUMMARY
